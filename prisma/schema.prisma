generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Team {
  id          String   @id @default(cuid())
  guildId     String
  name        String
  roleId      String   // ✅ Removed @unique
  tier        String   @default("free")
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  players     Player[]
  events      Event[]
  
  @@unique([guildId, roleId]) // ✅ roleId unique per guild
  @@index([guildId])
  @@index([roleId])
}

model Player {
  id        String   @id @default(cuid())
  discordId String
  username  String
  teamId    String
  addedBy   String?
  createdAt DateTime @default(now())
  
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  responses Response[]
  
  @@unique([discordId, teamId])
  @@index([teamId])
  @@index([discordId])
}

model Event {
  id          String   @id @default(cuid())
  teamId      String
  name        String
  date        String
  time        String
  gameType    String?
  notes       String?
  createdBy   String
  messageId   String?
  channelId   String?
  createdAt   DateTime @default(now())
  
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  responses Response[]
  
  @@index([teamId])
  @@index([createdAt])
  @@index([messageId]) // ✅ ADDED THIS INDEX
}

model Response {
  id        String   @id @default(cuid())
  playerId  String
  eventId   String
  status    String
  timestamp DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([playerId, eventId])
  @@index([eventId])
  @@index([playerId])
}